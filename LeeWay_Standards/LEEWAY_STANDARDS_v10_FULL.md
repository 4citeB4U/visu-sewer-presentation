# LEEWAY_STANDARDS_v10_FULL.md

This file bundles **all LEEWAY v10 standards and enforcement scripts** in one place.

---

## 1. LEEWAY_STANDARDS.md

```markdown
# LEEWAY INDUSTRIES — THE ORDER (v10, model-agnostic)

> Purpose: a **code-first standard** that keeps every project readable, testable, profitable, and safe by default.  
> Scope: repos, apps, agents, CLIs, services, docs. Works with **any** AI provider (OpenAI, Anthropic, Google, Mistral, local, on-device).

---

## 0. Charter (read first)

**Who**: All teams, contractors, agents.  
**What**: Machine-checkable rules for headers, structure, testing, security, SEO/voice, and monetization.  
**When**: File creation, every PR, pre-release, and periodically in CI.  
**Where**: All code & docs (exceptions: vendored/third-party with micro-headers).  
**How**: Headers, regions, lint/type gates, budget gates, logs DB, visual diagnostics, audit scripts.  
**Why**: Faster reviews, fewer regressions, measurable growth (traffic, conversions, revenue).  
**If**: You follow the Order → portable, learnable, low-cost software.  
**If not**: CI blocks; owners notified; fixes required.

---

## 1. Identity & Headers (immutable provenance)

**Rule**: Every **first-party** file starts with a **LEEWAY HEADER** using the language’s comment style.

**Long Header fields (exact keys)**  
`TAG`, `COLOR_ONION_HEX`, `ICON_FAMILY`, `ICON_GLYPH`, `ICON_SIG`,  
`5WH: WHAT; WHY; WHO; WHERE; WHEN; HOW`, `SPDX-License-Identifier`, `AGENTS`.

- `TAG` never changes after first commit.  
- `SIG`/`COLOR_ONION_HEX` may be regenerated by tools.  
- For generated or private files use a **Micro Header**:  
  `LEEWAY MICRO: TAG=<…> SIG=<…> OWNER=<…> WHEN=<ISO>`

**CI**: Missing/invalid header → **fail**. See `Apply-LeewayHeaders*.ps1` and audits.

---

## 2. Tracks & Separation (one language per package)

- **TS track**: TS/TSX only; strict; ESLint + Prettier; Vite/TSUP.  
- **JS track**: JS/JSX only; ES modules; ESLint; Vite/Rollup.  
- **Python track**: Black; Ruff; type hints for public APIs; pyproject.  
- **Go track**: gofmt; no panics in libs.  
- **Rust track**: rustfmt; clippy pedantic for libs.

Mixing tracks in one package → CI “mixed-track” error.

---

## 3. Regions & Learnability

Non-trivial files (>100 lines) use editor-recognized **regions**:

`Metadata`, `Init`, `Public API`, `Internals`, `I/O`, `Tests`.

---

## 4. Edge-First, Mobile-Second

**Perf budgets (baseline)**  
- First Interaction ≤ **2.5 s** (low-end device)  
- Initial JS ≤ **200 KB gz**  
- PWA installable; offline shell renders; queued writes (IndexedDB/SQLite) flush on reconnect.  
- Respect `navigator.connection` and battery; degrade media/ML quality gracefully.

---

## 5. Security & Privacy (defaults that protect)

- **Input hardening**: sanitize/escape/validate **all** inputs (including prompts).  
- **Prompt boundaries**: separate system rules from user data; quote/delimit user content.  
- **Output filtering**: scan model/app output for leaks.  
- **AuthZ**: role-based access; least privilege; rate-limit.  
- **Secrets**: no secrets in code; `.env.example` only; real secrets in secret manager.  
- **Data minimization**: collect/store only what’s necessary; encrypt at rest & in transit.  
- **Sandboxing**: isolate untrusted code and model tool use.  
- **Detect/Respond**: monitoring, anomaly detection, incident playbook.

**Model-agnostic policy**: same guardrails for hosted, on-prem, local, or on-device models.

---

## 6. Logs Database (runs • events • attempts)

Fields: `ts, level, module, operation, message, data, file_path, line, region_tag, diag_code, runId`.  
Recurrent `diag_code` → show **prior fix** suggestion in overlay.

---

## 7. Visual Diagnostics

Severity palette: INFO `#1E90FF`, SUCCESS `#22C55E`, WARN `#F59E0B`, ERROR `#EF4444`, FATAL `#7F1D1D`, highlight `#39FF14`.  
Error zones use `.leeway-error-throb`.

---

## 8. Documentation & “Why”

Short rationale in headers and READMEs. If you can explain design from docs alone → ✅

---

## 9. Testing & CI Gates

- Formatters clean.  
- Lint/typecheck: zero errors.  
- Header validator.  
- Edge budgets.  
- **SEO/Voice** validation.  
- Diagnostics artifact: HTML heatmap + top 20 hotspots.

---

## 10. Naming & Structure

- Folders: kebab-case (web), snake_case (Python).  
- Components: PascalCase; vars camelCase; Py snake_case.  
- Assets: `/public/image/<kebab>-vN.ext`.

---

## 11. Search/Voice/Entity — Dominate Answer Engines

### 11.1 Structured Data
JSON-LD via centralized helpers. Types: `Organization`, `LocalBusiness`, `Product`, `Service`, `Article`, `FAQPage`, `HowTo`, `BreadcrumbList`, `WebSite`.

### 11.2 Local/Knowledge Ecosystem
Sync across Google, Apple, Yelp, Bing, Foursquare. Collect/reply to reviews.

### 11.3 Content Patterns for Voice
Key pages answer in ≤75 words. FAQPage JSON-LD required. Speakable optional.

### 11.4 CI Validation
All structured data validated. FAQPage or Speakable required. Org schema present.

---

## 12. Monetization by Design

- UTM tracking.  
- CTA components with pricing toggles.  
- Usage hooks emit `revenue:*` events.  
- Ad/affiliate wrappers with consent.  
- Tiered features with flags.  
- Paywalls optional.  
- AI cost control with budget caps and fallback providers.

### 12.1 Profitability Standard (Profit-First)

All releases must meet profitability thresholds unless explicitly waived by owners:

- ROAS ≥ 4x (configurable)
- LTV:CAC ≥ 3x (configurable)
- CAC ≤ cap (default 120)

Enforcement: a CI gate script `scripts/leeway_profit_gate.mjs` reads `data/snapshots/last.json` and exits non-zero if thresholds fail. Configure with env vars `MIN_ROAS`, `MIN_LTV_CAC`, `MAX_CAC`, and `MKTG_SNAPSHOT`.

Example snapshot JSON:

```json
{ "roas": 4.2, "ltvToCac": 3.4, "cac": 55 }
```

Add an optional marketing dashboard (`src/routes/dashboard/MarketingDashboard.tsx`) to visualize CSV-based KPIs and align product decisions to the gate.

---

## 13. Cost & Free-Tier Discipline

Prefer free/open or local inference; fallback; cost toggles checked in.

---

## 14. Release & Packaging

Signed artifacts; minimal permissions; PWA update path verified.

---

## 15. Ownership & Heatmaps

Nightly analytics → weekly hotspot roll-ups.

---

## 16. Change Control & Commit Style

Conventional commits. Small PRs.

---

## 17. Minimum Starter Kit

- Header validators.  
- CI: format/lint/type/header/SEO/offline/budget checks.  
- Visual overlay.  
- Logs DB migrations.  
- IndexedDB/SQLite queue.  
- SEO helpers.  
- Monetization SDK.

---

## 17.1 Bootstrap (auto-managed, OS-agnostic, Universal)

**Truth source:** this standards file. LEEWAY works with ANY project structure - not tied to specific frameworks.

**Universal Auto-Detection:**
- **Frontend Root:** Auto-detects from `frontend/`, `src/`, `client/`, `web/`, `app/`, or current directory
- **Backend Root:** Auto-detects from `backend/`, `server/`, `api/`, `services/` with fallback
- **Public Directory:** Auto-detects from `public/`, `static/`, `assets/`, `dist/`

**Configurable Requirements:** Set via environment variables:
```bash
# Universal mode (no specific requirements)
LW_REQUIRED_IMAGES="" LW_REQUIRED_DIRS="" node leeway_unified_audit.cjs

# Project-specific mode
LW_REQUIRED_IMAGES="logo.png,icon.svg" node leeway_unified_audit.cjs
LW_FRONTEND_ROOT="client" LW_BACKEND_ROOT="server" node leeway_unified_audit.cjs
```

**Bootstrap artifacts (created if missing):**
- `.vscode/settings.json` with LEEWAY headers + zero-problems gates.
- `public/agentlee.config.js` (runtime config shell; **no secrets**; may be blank).
- `cf-proxy/` Cloudflare Worker scaffolding (secure Gemini proxy; key stored as Worker secret).
- `.github/workflows/deploy-worker.yml` to publish the Worker.

**Path policy:** use `path.resolve(REPO_ROOT, "<relative>")`; never use absolute drive letters.  
**Secrets policy:** never in code, never in Pages; Worker keeps keys server-side.  
**Strict mode:** missing artifacts or secrets = CI fail with actionable hints.  
**Model/system:** provider-agnostic; Windows/macOS/Linux validated in CI matrix.

---

## Appendix A: Pre-Deployment Checklist

- Tests: unit/integration/E2E.  
- Security: input validation, secret scan, SBOM.  
- SEO/Voice: JSON-LD valid; FAQ or Speakable present.  
- Performance: budgets respected.  
- Configs: no dev/test creds.  
- DB: migrations & rollback tested.  
- Monitoring: APM, logs ingestion.  
- Monetization: revenue events fire.  
- Release: signed artifacts.  
- Docs: updated.  
- Owner ACK.

---

## Appendix B: Model-Agnostic AI Usage

- Keep providers behind interfaces.  
- Same guardrails regardless of provider.  
- Fallback logic.  
- Prompt rules: quote input, never interpolate into system rules, redact logs.

```

---

## 2. `leeway_audit.py`

```python
# region Metadata
# LEEWAY HEADER 
# TAG: BACKEND.AUDIT
# 5WH: WHAT=Audit backend files for standards; WHY=Ensure compliance; WHO=Leeway; WHERE=repo backend; WHEN=runtime/CI; HOW=Python script
# SPDX-License-Identifier: MIT
# endregion

import os, re, sys

HEADER_RE = re.compile(r"LEEWAY HEADER  DO NOT REMOVE|LEEWAY MICRO:", re.M)


def audit_file(path: str) -> list[str]:
    issues = []
    with open(path, encoding="utf-8") as f:
        text = f.read()
    first_line = text.splitlines()[0] if text.splitlines() else ""
    if "LEEWAY HEADER" not in first_line and "LEEWAY MICRO" not in first_line:
        issues.append("Missing LEEWAY HEADER")
    if len(text.splitlines()) > 200 and "region" not in text:
        issues.append("No regions in large file")
    return issues


def walk(root: str):
    for dirpath, _, files in os.walk(root):
        for file in files:
            if file.endswith((".py",".ts",".tsx",".js",".jsx")):
                yield os.path.join(dirpath,file)


if __name__ == "__main__":
    root = sys.argv[1] if len(sys.argv)>1 else "."
    failed = False
    for path in walk(root):
        issues = audit_file(path)
        if issues:
            failed = True
            print(f"{path}: {issues}")
    sys.exit(1 if failed else 0)
```

---

## 3. `leeway_frontend_audit.py`

```python
# region Metadata
# LEEWAY HEADER 
# TAG: FRONTEND.AUDIT
# 5WH: WHAT=Audit frontend files; WHY=Compliance; WHO=Leeway; WHERE=repo frontend; WHEN=runtime/CI; HOW=Python script
# SPDX-License-Identifier: MIT
# endregion

import os, re, sys

HEADER_RE = re.compile(r"LEEWAY HEADER  DO NOT REMOVE|LEEWAY MICRO:", re.M)


def audit_file(path: str):
    issues = []
    with open(path, encoding="utf-8") as f:
        text = f.read()
    first_line = text.splitlines()[0] if text.splitlines() else ""
    if "LEEWAY HEADER" not in first_line and "LEEWAY MICRO" not in first_line:
        issues.append("Missing LEEWAY HEADER")
    if "export default" not in text and "function" not in text and "class" not in text:
        issues.append("No exports/functions/classes detected")
    return issues


def walk(root: str):
    for dirpath, _, files in os.walk(root):
        for file in files:
            if file.endswith((".tsx",".jsx",".ts",".js")):
                yield os.path.join(dirpath,file)


if __name__ == "__main__":
    root = sys.argv[1] if len(sys.argv)>1 else "."
    failed = False
    for path in walk(root):
        issues = audit_file(path)
        if issues:
            failed=True
            print(f"{path}: {issues}")
    sys.exit(1 if failed else 0)
```

---

## 4. `Apply-LeewayHeaders.ps1`

```powershell
<# LEEWAY HEADER 
# TAG: BACKEND.HEADERS
# 5WH: WHAT=Ensure headers in backend; WHY=Provenance; WHO=Leeway; WHERE=repo backend; WHEN=pre-commit/CI; HOW=PowerShell
# SPDX-License-Identifier: MIT
#>

param([string]$Root=".")

$files = Get-ChildItem -Recurse -Path $Root -Include *.py,*.js,*.ts,*.jsx,*.tsx | Where-Object { -not $_.PSIsContainer }
foreach ($file in $files) {
  $content = Get-Content $file.FullName -Raw
  if ($content -notmatch "LEEWAY HEADER" -and $content -notmatch "LEEWAY MICRO:") {
    Write-Output "Missing header in $($file.FullName)"
    exit 1
  }
}
```

---

## 5. `Apply-LeewayHeaders-frontend.ps1`

```powershell
<# LEEWAY HEADER 
# TAG: FRONTEND.HEADERS
# 5WH: WHAT=Ensure headers in frontend; WHY=Provenance; WHO=Leeway; WHERE=repo frontend; WHEN=pre-commit/CI; HOW=PowerShell
# SPDX-License-Identifier: MIT
#>

param([string]$Root="frontend")

$files = Get-ChildItem -Recurse -Path $Root -Include *.tsx,*.jsx,*.js,*.ts | Where-Object { -not $_.PSIsContainer }
foreach ($file in $files) {
  $content = Get-Content $file.FullName -Raw
  if ($content -notmatch "LEEWAY HEADER" -and $content -notmatch "LEEWAY MICRO:") {
    Write-Output "Missing header in $($file.FullName)"
    exit 1
  }
}
```

---

## 6. `enforce-authors.mjs`

```javascript
// LEEWAY HEADER  
// TAG: ENFORCE.AUTHORS
// 5WH: WHAT=Ensure authors & headers; WHY=Provenance; WHO=Leeway; WHERE=repo; WHEN=CI/pre-commit; HOW=Node script
// SPDX-License-Identifier: MIT

import fs from "fs";
import path from "path";

function walk(dir) {
  let results = [];
  for (const entry of fs.readdirSync(dir)) {
    const p = path.join(dir, entry);
    const stat = fs.statSync(p);
    if (stat.isDirectory()) results = results.concat(walk(p));
    else if (/\.(js|ts|jsx|tsx|py)$/.test(p)) results.push(p);
  }
  return results;
}

const files = walk(".");
let failed = false;

for (const file of files) {
  const text = fs.readFileSync(file, "utf8");
  if (!text.includes("LEEWAY HEADER") && !text.includes("LEEWAY MICRO:")) {
    console.error(`Missing header in ${file}`);
    failed = true;
  }
  if (!/SPDX-License-Identifier/.test(text)) {
    console.error(`Missing SPDX in ${file}`);
    failed = true;
  }
}

if (failed) process.exit(1);
```

---

## 7. Monetization SDK — `src/lib/monetization/index.ts` (reference)

> NOTE: frontend track must be JS/JSX only; this TypeScript reference should be ported to `src/lib/monetization/index.js` when integrating into the frontend.

```ts
// LEEWAY HEADER 
// TAG: LIB.MONETIZATION
// 5WH: WHAT=Monetization helpers; WHY=Revenue by default; WHO=Leeway; WHERE=client/server; WHEN=runtime; HOW=TypeScript SDK
// SPDX-License-Identifier: MIT

export type RevenueEvent =
  | "view_offer"
  | "start_checkout"
  | "purchase"
  | "renewal"
  | "cancel";

export interface RevenuePayload {
  event: RevenueEvent;
  plan?: string;
  price?: number;
  currency?: string;
  userId?: string;
  meta?: Record<string, any>;
}

export function emitRevenue(payload: RevenuePayload) {
  console.log("Revenue event:", payload);
  // TODO: send to logs DB / analytics pipeline
}
```

---

## 8. Monetization SDK Tests — reference (TS)

```ts
import { emitRevenue } from "../index";

describe("emitRevenue", () => {
  it("emits a purchase event", () => {
    const spy = jest.spyOn(console, "log").mockImplementation();
    emitRevenue({ event: "purchase", price: 9.99, currency: "USD" });
    expect(spy).toHaveBeenCalled();
    spy.mockRestore();
  });
});
```

---

## 9. SEO / Structured Data Helpers — reference

```ts
// LEEWAY HEADER 
// TAG: LIB.SEO.STRUCTURED_DATA
// 5WH: WHAT=Generate JSON-LD; WHY=Voice/SEO dominance; WHO=Leeway; WHERE=web; WHEN=runtime; HOW=TS utils
// SPDX-License-Identifier: MIT

export function generateFAQPage(faqs: {question:string, answer:string}[]) {
  return {
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": faqs.map(f => ({
      "@type": "Question",
      "name": f.question,
      "acceptedAnswer": { "@type": "Answer", "text": f.answer }
    }))
  };
}
```

---

## 10. DOM Injection Helper — reference

```ts
// LEEWAY HEADER 
// TAG: LIB.SEO.STRUCTURED_DATA.DOM
// 5WH: WHAT=Inject JSON-LD to DOM; WHY=SEO/voice; WHO=Leeway; WHERE=web client; WHEN=runtime; HOW=append script
// SPDX-License-Identifier: MIT

export function injectJsonLd(data: any) {
  const script = document.createElement("script");
  script.type = "application/ld+json";
  script.text = JSON.stringify(data);
  document.head.appendChild(script);
}
```

---

```

